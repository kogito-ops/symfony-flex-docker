version: "3.8"
services:
  redis:
    image: docker.io/library/redis:6.2.3-alpine3.13
    restart: on-failure
    env_file:
      - .env
    healthcheck:
      test:
        - CMD-SHELL
        - redis-cli PING || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    volumes:
      - "redis_data:/data"
  mariadb:
    build:
      context: ./
      dockerfile: ./docker/mariadb/Dockerfile
    restart: on-failure
    env_file:
      - .env
    healthcheck:
      test:
        - "CMD"
        - "mysqladmin"
        - "ping"
        - "--user=$MYSQL_USER"
        - "--password=$MYSQL_PASSWORD"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    volumes:
      - "mariadb_data:/var/lib/mysql"
  postgres:
    build:
      context: ./
      dockerfile: ./docker/postgres/Dockerfile
    restart: on-failure
    env_file:
      - .env
    healthcheck:
      test:
        - "CMD-SHELL"
        - "pg_isready -U $POSTGRES_USER"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    volumes:
      - "postgres_data:/var/lib/postgresql/data"
  node:
    build:
      context: ./
      dockerfile: ./docker/node/Dockerfile
    command:
      - yarn
      - build
    # volumes:
    #   - "webpack_assets:/srv/app/public/build/"
    #   - "bundle_assets:/srv/app/public/bundles/"
  php:
    build:
      context: ./
      dockerfile: ./docker/php-fpm/Dockerfile
    env_file:
      - .env
    depends_on:
      - redis
      - mariadb
      - postgres
      - node
    # volumes:
    #   - "symfony_cache:/srv/app/var/"
    #   - "webpack_assets:/srv/app/public/build/"
    #   - "bundle_assets:/srv/app/public/bundles/"
  nginx:
    build:
      context: ./
      dockerfile: ./docker/nginx/Dockerfile
    depends_on:
      - php
    ports:
      - "8080:80"
      - "8443:443"
    # volumes:
    #   - "webpack_assets:/srv/app/public/build/"
    #   - "bundle_assets:/srv/app/public/bundles/"
volumes:
  redis_data:
    driver: local
  mariadb_data:
    driver: local
  postgres_data:
    driver: local
  symfony_cache:
    driver: local
  webpack_assets:
    driver: local
  bundle_assets:
    driver: local
